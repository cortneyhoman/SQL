-- What was the average amount invoiced per country in 2010, rounded to the nearest dollar?
SELECT BillingCountry, ROUND(AVG(Total),0) as avgInvoiced
FROM chinook.invoices
WHERE InvoiceDate LIKE '%2010%'
GROUP BY BillingCountry;

-- List the artist, title, and total quantity sold for the top 5 most purchased tracks.
SELECT tr.Name, ar.Name, SUM(Quantity) as totalSold
FROM chinook.tracks tr
JOIN chinook.albums al
ON tr.AlbumId=al.AlbumId
JOIN chinook.artists ar
ON al.ArtistId=ar.ArtistId
JOIN chinook.invoice_items ii
ON tr.TrackId=ii.TrackId
GROUP BY tr.Name
ORDER BY totalSold DESC
LIMIT 5;

-- Which customer support rep is assigned to the fewest number of customer accounts?
WITH repTotals AS (
SELECT c.SupportRepId, e.FirstName, e.LastName, COUNT(c.SupportRepId) AS repTotal
FROM customers c
JOIN employees e
ON c.SupportRepId=e.EmployeeId
GROUP BY c.SupportRepId)

SELECT SupportRepId, FirstName, LastName, MIN(repTotal) as "totalAssignedAccounts"
FROM repTotals;

-- Show the full name, customer ID, and country for all customers who are not in the US.
SELECT CustomerId, FirstName, LastName, Country
FROM chinook.customers
WHERE Country <> 'USA';

-- Show the full name and customer ID for all customers who are from Brazil.
SELECT CustomerId, FirstName, LastName, Country
FROM chinook.customers
WHERE Country = 'Brazil';

-- Find the invoices of customers who are from Brazil. The resulting table should show the customer's full name, invoice ID, invoice date, and billing country.
SELECT FirstName, LastName, InvoiceId, InvoiceDate, BillingCountry
FROM chinook.customers c
JOIN chinook.invoices i
ON c.CustomerId=i.CustomerId
WHERE c.Country = 'Brazil';

-- Show the employees who are sales agents.
SELECT FirstName, LastName, Title
FROM chinook.employees
WHERE Title LIKE '%Agent%';

-- Find a unique/distinct list of billing countries from the invoice table.
SELECT DISTINCT BillingCountry
FROM chinook.invoices;

-- Provide a query that shows the invoices associated with each sales agent. The resulting table should include the invoice ID and sales agent's full name.
SELECT i.InvoiceId, e.FirstName, e.LastName
FROM chinook.invoices i
JOIN chinook.customers c
ON i.CustomerId=c.CustomerId
JOIN chinook.employees e
ON c.SupportRepId=e.EmployeeId;

-- Show the invoice total, customer name, country, and sales agent name for all invoices and customers.
SELECT i.Total, c.FirstName as custFirst, c.LastName as custLast, c.Country, e.FirstName as salesRepFirst, e.LastName as salesRepLast
FROM chinook.invoices i
JOIN chinook.customers c
ON i.CustomerId=c.CustomerId
JOIN chinook.employees e
ON c.SupportRepId=e.EmployeeId;

-- How many Invoices were there in 2009?
SELECT COUNT(*)
FROM chinook.invoices
WHERE InvoiceDate LIKE '%2009%';

-- What are the total sales for 2009?
SELECT SUM(Total)
FROM chinook.invoices
WHERE InvoiceDate LIKE '%2009%';

-- Show the purchased track name with each invoice ID and invoice line ID.
SELECT t.Name, ii.InvoiceId, ii.InvoiceLineID
FROM chinook.tracks t
JOIN chinook.invoice_items ii
ON t.TrackId=ii.TrackId;

-- Show the purchased track name AND artist name with each invoice ID and invoice line ID.
SELECT t.Name as trackName, ar.Name as artistName, ii.InvoiceId, ii.InvoiceLineID
FROM chinook.tracks t
JOIN chinook.invoice_items ii
ON t.TrackId=ii.TrackId
JOIN chinook.albums a 
ON t.AlbumId=a.AlbumId
JOIN chinook.artists ar
ON a.ArtistId=ar.ArtistId;

-- Show all tracks with album name, media type, and genre.
SELECT t.Name as trackTitle, a.Title as albumTitle, m.Name as mediaType, g.Name as Genre
FROM chinook.tracks t
JOIN chinook.albums a
ON t.AlbumId=a.AlbumId
JOIN chinook.media_types m
ON t.MediaTypeId=m.MediaTypeId
JOIN chinook.genres g
ON t.GenreId=g.GenreId;

-- Show the total sales made by each sales agent.
SELECT ROUND(SUM(i.Total),2) as totalSales, e.FirstName, e.LastName
FROM chinook.invoices i
JOIN chinook.customers c
ON i.CustomerId=c.CustomerId
JOIN chinook.employees e
ON c.SupportRepId=e.EmployeeId
WHERE e.Title LIKE '%Agent%'
GROUP BY e.LastName;

-- Which sales agent made the most dollars in sales in 2009 and what was their sales total?
WITH tempSales AS (
SELECT e.FirstName as agentFirst, e.LastName as agentLast, SUM(Total) as totalSales
FROM invoices i
JOIN customers c
ON i.CustomerId=c.CustomerId
JOIN employees e
ON c.SupportRepId=e.EmployeeId
WHERE InvoiceDate LIKE '%2009%'
GROUP BY e.LastName)

SELECT agentFirst, agentLast, ROUND(MAX(totalSales),2) as totalSales
FROM tempSales;
